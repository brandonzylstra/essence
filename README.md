# Essence - Database Schema Management

[![Gem Version](https://badge.fury.io/rb/essence.svg)](https://badge.fury.io/rb/essence)
[![Ruby](https://github.com/brandonzylstra/essence/workflows/Ruby/badge.svg)](https://github.com/brandonzylstra/essence/actions)

**Essence** is a powerful tool for rapid database schema iteration in Rails applications. It provides a clean, YAML-based syntax with intelligent defaults and pattern matching that compiles to Atlas HCL format for seamless database migrations.

## üöÄ Why Essence?

- **10x faster schema iteration** - Write schemas in clean YAML instead of verbose Rails migrations or GUI tools
- **Smart defaults** - Automatic `id`, `created_at`, `updated_at` columns for every table
- **Pattern-based property inference** - `league_id: ~` automatically becomes a foreign key to `leagues.id`
- **Version control friendly** - Text-based schemas that diff and merge cleanly
- **Rails integration** - Seamless workflow with rake tasks and Atlas backend
- **Template generation** - Quick project setup with sensible defaults

## üì¶ Installation

Add this line to your application's Gemfile:

```ruby
gem 'essence'
```

And then execute:

```bash
$ bundle install
```

Or install it yourself as:

```bash
$ gem install essence
```

## üèóÔ∏è Quick Start

### 1. Generate a schema template

```bash
# In your Rails project
rake essence:template
```

This creates `db/schema.yaml` with sensible defaults:

```yaml
# Enhanced Essence Schema with Default Columns and Pattern Matching
schema_name: main
rails_version: "8.0"

defaults:
  "*":
    columns:
      id: primary_key
      created_at: datetime not_null
      updated_at: datetime not_null

column_patterns:
  - pattern: "_id$"
    template: "integer -> {table}.id on_delete=cascade not_null"
  - pattern: "_at$"
    attributes: "datetime not_null"
  - pattern: ".*"
    attributes: "string"

tables:
  users:
    columns:
      email: string(255) not_null unique
      name: string(100) not_null
      league_id: ~
      last_login_at: ~

  leagues:
    columns:
      name: string(255) not_null unique
      description: text
```

### 2. Compile to HCL format

```bash
rake essence:compile
```

This generates `db/schema.hcl` in Atlas format with foreign keys automatically resolved:

```hcl
schema "main" {
  comment = "Generated by Essence"
}

table "users" {
  schema = schema.main
  column "id" {
    null = false
    type = integer
    auto_increment = true
  }
  column "email" {
    null = false
    type = varchar(255)
  }
  column "name" {
    null = false
    type = varchar(100)
  }
  column "league_id" {
    null = false
    type = integer
  }
  column "last_login_at" {
    null = false
    type = datetime
  }
  column "created_at" {
    null = false
    type = datetime
  }
  column "updated_at" {
    null = false
    type = datetime
  }
  primary_key {
    columns = [column.id]
  }
  foreign_key "FK_USERS_LEAGUE" {
    columns     = [column.league_id]
    ref_columns = [table.leagues.column.id]
    on_delete   = CASCADE
  }
  index "IDX_USERS_EMAIL" {
    columns = [column.email]
    unique  = true
  }
}
```

### 3. Preview and apply changes

```bash
# See what would change
rake essence:preview

# Generate Rails migration and apply
rake essence:deploy["add tournament tables"]
```

## üéØ Core Features

### Smart Defaults
Every table automatically gets:
- `id` primary key column
- `created_at` and `updated_at` timestamps
- Proper indexing and constraints

### Pattern-Based Intelligence
Write `league_id: ~` and get:
- Integer column
- Foreign key to `leagues.id`
- Cascade delete
- Proper indexing

### Clean YAML Syntax
```yaml
tables:
  tournaments:
    columns:
      name: string(255) not_null unique
      league_id: ~  # Becomes foreign key automatically
      start_date: ~  # Becomes datetime not_null
      is_active: ~   # Becomes boolean default false
      max_teams: ~   # Becomes integer
```

### Full Rails Integration
```bash
rake essence:template     # Generate schema template
rake essence:convert      # Convert YAML to HCL
rake essence:preview      # Preview changes
rake essence:apply        # Apply to database
rake essence:deploy[name] # Full workflow
```

## üìã Available Patterns

Essence automatically recognizes these column patterns:

| Pattern | Example | Result |
|---------|---------|--------|
| `*_id` | `user_id: ~` | `integer -> users.id on_delete=cascade not_null` |
| `*_at` | `published_at: ~` | `datetime not_null` |
| `*_on` | `published_on: ~` | `date not_null` |
| `*_date` | `birth_date: ~` | `date not_null` |
| `is_*` | `is_active: ~` | `boolean default false not_null` |
| `has_*` | `has_premium: ~` | `boolean default false not_null` |
| `can_*` | `can_edit: ~` | `boolean default false not_null` |
| `*_flag` | `admin_flag: ~` | `boolean default false not_null` |
| `*_content` | `body_content: ~` | `text` |
| `*_body` | `email_body: ~` | `text` |
| `*_text` | `description_text: ~` | `text` |
| `*_html` | `content_html: ~` | `text` |
| `*_count` | `view_count: ~` | `integer default 0 not_null` |
| `*_score` | `rating_score: ~` | `decimal(5,2) default 0.0 not_null` |
| `*_amount` | `price_amount: ~` | `decimal(10,2) not_null` |
| `*_price` | `unit_price: ~` | `decimal(10,2) not_null` |
| `*_email` | `contact_email: ~` | `string(255) not_null` |
| `*_url` | `website_url: ~` | `string(500)` |
| `*_code` | `product_code: ~` | `string(50) not_null` |
| `*_slug` | `permalink_slug: ~` | `string(255) not_null unique` |
| `*_status` | `order_status: ~` | `string(50) not_null` |
| `*_state` | `workflow_state: ~` | `string(50) not_null` |

## üõ†Ô∏è Advanced Usage

### Custom Patterns
Define your own patterns in the schema:

```yaml
column_patterns:
  - pattern: "_uuid$"
    properties: "uuid not_null unique"
  - pattern: "_json$"
    properties: "json"
  - pattern: "encrypted_"
    properties: "text not_null"
```

### Table-Specific Defaults
Override defaults for specific tables:

```yaml
defaults:
  "*":
    columns:
      id: primary_key
      created_at: datetime not_null
      updated_at: datetime not_null
  "audit_*":
    columns:
      id: uuid primary_key
      created_at: datetime not_null
      created_by: string(255) not_null
```

### Explicit Overrides
Override pattern matching with explicit definitions:

```yaml
tables:
  users:
    columns:
      league_id: string(50) not_null  # Override foreign key pattern
      created_at: timestamp not_null  # Override default
```

## üîÑ Workflow Integration

### Complete Development Workflow

```bash
# 1. Set up (first time)
rake essence:init           # Import existing schema
# OR
rake essence:template       # Start fresh

# 2. Edit schema
vim db/schema.yaml

# 3. Iterate rapidly
rake essence:compile        # YAML ‚Üí HCL
rake essence:preview        # See changes
rake essence:generate[name] # Create migration
rake essence:apply          # Apply to DB

# 4. Deploy
rake essence:deploy[name]   # All-in-one
```

### CI/CD Integration

```yaml
# .github/workflows/schema.yml
name: Schema Validation
on: [push, pull_request]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      - name: Validate schema
        run: rake essence:validate
```

## üìö Command Reference

### CLI Commands
```bash
essence template [path]         # Generate template
essence compile [yaml] [hcl]    # Compile formats
essence version                 # Show version
essence help                    # Show help
```

### Rake Tasks
```bash
rake essence:template[path]     # Generate schema template
rake essence:compile[yaml,hcl]  # Compile YAML to HCL
rake essence:preview            # Preview changes
rake essence:generate[name]     # Generate Rails migration
rake essence:apply              # Apply schema to database
rake essence:deploy[name]       # Full workflow
rake essence:seed               # Generate seed data
rake essence:init               # Initialize from existing
rake essence:validate           # Validate schema
rake essence:history            # Show migration history
rake essence:help               # Show all commands
```

## üèóÔ∏è Architecture

Essence works by:

1. **YAML Definition** - You write clean, pattern-rich schemas
2. **Pattern Resolution** - Automatic foreign keys, constraints, indexes
3. **HCL Generation** - Compiles to Atlas-compatible HCL format
4. **Atlas Integration** - Uses Atlas for migration planning
5. **Rails Compatibility** - Generates standard Rails migrations

```
schema.yaml ‚Üí [Essence] ‚Üí schema.hcl ‚Üí [Atlas] ‚Üí migration.rb ‚Üí [Rails] ‚Üí Database
```

## üíª Examples

### Basic Blog Schema
```yaml
schema_name: blog
tables:
  users:
    columns:
      email: string(255) not_null unique
      username: string(50) not_null unique
      first_name: string(100)
      last_name: string(100)
      is_admin: ~
      last_login_at: ~

  posts:
    columns:
      title: string(255) not_null
      post_slug: ~
      content_html: ~
      user_id: ~
      published_at: ~
      is_published: ~
      view_count: ~

  comments:
    columns:
      post_id: ~
      user_id: ~
      comment_body: ~
      is_approved: ~
```

### E-commerce Schema
```yaml
schema_name: ecommerce
tables:
  customers:
    columns:
      email: string(255) not_null unique
      first_name: string(100) not_null
      last_name: string(100) not_null
      phone: string(20)
      birth_date: ~
      is_active: ~

  products:
    columns:
      name: string(255) not_null
      product_code: ~
      description_text: ~
      unit_price: ~
      cost_amount: ~
      stock_count: ~
      is_active: ~

  orders:
    columns:
      customer_id: ~
      order_status: ~
      total_amount: ~
      tax_amount: ~
      shipping_amount: ~
      order_date: ~
      shipped_at: ~
```

## ü§ù Contributing

1. Fork it (https://github.com/brandonzylstra/essence/fork)
2. Create your feature branch (`git checkout -b my-new-feature`)
3. Commit your changes (`git commit -am 'Add some feature'`)
4. Push to the branch (`git push origin my-new-feature`)
5. Create a new Pull Request

## üìÑ License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).

## üôè Acknowledgments

- [Atlas](https://atlasgo.io/) for the powerful migration engine
- [Rails](https://rubyonrails.org/) for the amazing framework
- The Ruby community for inspiration and support
